<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>申请加入会员 | 中欧心血管代谢联盟</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.iconify.design/3/3.1.1/iconify.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1A2B4C',
                        secondary: '#20345D',
                        accent: '#3A86FF',
                        light: '#F8F9FA',
                        dark: '#333333',
                    },
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .nav-shadow { box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
            .nav-underline::after {
                content: "";
                display: block;
                height: 2px;
                background: #D94141;
                width: 100%;
                margin-top: 6px;
            }
            .nav-dropdown {
                padding-bottom: 0.75rem;
            }
            .nav-dropdown:hover .dropdown-menu,
            .nav-dropdown:focus-within .dropdown-menu {
                opacity: 1;
                visibility: visible;
                transform: translateY(0);
            }
            /* 用户下拉菜单样式 - 确保背景色始终可见 */
            #user-menu-container {
                position: relative;
            }
            #user-menu-container .dropdown-menu {
                background-color: #FFFFFF !important;
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15) !important;
                border: 2px solid #E5E7EB !important;
                pointer-events: auto;
            }
            /* 在下拉菜单上方创建不可见的悬停桥接区域 */
            #user-menu-container .dropdown-menu::before {
                content: '';
                position: absolute;
                bottom: 100%;
                left: 0;
                right: 0;
                height: 8px;
                background: transparent;
            }
            /* 用户菜单悬停展开 */
            #user-menu-container:hover .dropdown-menu,
            #user-menu-container:focus-within .dropdown-menu,
            #user-menu-container .dropdown-menu:hover {
                opacity: 1 !important;
                visibility: visible !important;
                transform: translateY(0) !important;
            }
        }
    </style>
</head>
<body class="font-sans text-dark bg-light flex flex-col min-h-screen">
    <header class="sticky top-0 z-50 shadow-sm">
        <div class="bg-[#2A59A6] text-white">
            <div class="max-w-[1240px] mx-auto px-6">
                <div class="h-12 flex items-center justify-between">
                    <div class="text-lg font-semibold tracking-wide">
                        <span class="block text-xs uppercase text-white/70">China-Europe Cardiometabolic Alliance</span>
                        <span class="text-xl font-bold">中欧心血管代谢联盟</span>
                    </div>
                    <div class="flex items-center space-x-6 text-sm" id="topbar-actions">
                        <button class="flex items-center space-x-2 hover:text-[#3A86FF] transition" type="button">
                            <span class="iconify" data-icon="material-symbols:search"></span>
                            <span>搜索</span>
                        </button>
                        <button class="hover:text-[#3A86FF] transition" type="button">EN / 中文</button>
                        <div class="relative" id="user-menu-container">
                            <a class="flex items-center space-x-2 hover:text-[#3A86FF] transition" href="login.html" id="user-login-link">
                                <span class="iconify" data-icon="material-symbols:person"></span>
                                <span>用户登录</span>
                            </a>
                            <button class="hidden items-center space-x-2" id="user-menu-button" type="button">
                                <span class="iconify" data-icon="material-symbols:person"></span>
                                <span id="user-name"></span>
                                <span class="iconify text-sm" data-icon="tabler:chevron-down"></span>
                            </button>
                            <div class="dropdown-menu absolute right-0 top-full mt-0 w-44 bg-white text-[#333333] border-2 border-gray-200 shadow-2xl rounded-md py-2 pt-2 opacity-0 invisible -translate-y-2 transition z-50 hidden">
                                <a class="block px-4 py-2 text-sm hover:bg-[#F8F9FA]" href="#">个人资料</a>
                                <a class="block px-4 py-2 text-sm hover:bg-[#F8F9FA]" href="#">账户设置</a>
                                <button class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-[#F8F9FA]" id="logout-button" type="button">
                                    退出登录
                                </button>
                            </div>
                        </div>
                        <a class="hidden flex items-center space-x-2 hover:text-[#3A86FF] transition" href="admin-dashboard.html" id="admin-link">
                            <span class="iconify" data-icon="material-symbols:shield-person"></span>
                            <span>管理员管理</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
        <div class="bg-white">
            <div class="max-w-[1240px] mx-auto px-6">
                <nav class="h-16 flex items-center justify-between text-lg text-[#D94141]">
                    <a class="font-semibold text-[#D94141] nav-underline" href="index.html">首页</a>
                    <div class="relative nav-dropdown">
                        <button class="flex items-center gap-1 hover:text-[#B83232] transition font-medium" type="button">
                            关于我们
                            <span class="iconify text-sm" data-icon="tabler:chevron-down"></span>
                        </button>
                        <div class="dropdown-menu absolute left-0 top-full mt-0 w-44 bg-white border border-gray-100 shadow-lg rounded-md py-2 opacity-0 invisible -translate-y-2 transition">
                            <a class="block px-4 py-2 text-sm text-[#333333] hover:bg-[#F8F9FA]" href="#">学会简介</a>
                            <a class="block px-4 py-2 text-sm text-[#333333] hover:bg-[#F8F9FA]" href="#">学会领导</a>
                            <a class="block px-4 py-2 text-sm text-[#333333] hover:bg-[#F8F9FA]" href="#">组织构架</a>
                            <a class="block px-4 py-2 text-sm text-[#333333] hover:bg-[#F8F9FA]" href="#">学会动态</a>
                            <a class="block px-4 py-2 text-sm text-[#333333] hover:bg-[#F8F9FA]" href="#">联系我们</a>
                        </div>
                    </div>
                    <div class="relative nav-dropdown">
                        <button class="flex items-center gap-1 hover:text-[#B83232] transition font-medium" type="button">
                            学术资源
                            <span class="iconify text-sm" data-icon="tabler:chevron-down"></span>
                        </button>
                        <div class="dropdown-menu absolute left-0 top-full mt-0 w-44 bg-white border border-gray-100 shadow-lg rounded-md py-2 opacity-0 invisible -translate-y-2 transition">
                            <a class="block px-4 py-2 text-sm text-[#333333] hover:bg-[#F8F9FA]" href="#">研究进展</a>
                            <a class="block px-4 py-2 text-sm text-[#333333] hover:bg-[#F8F9FA]" href="#">文献解读</a>
                            <a class="block px-4 py-2 text-sm text-[#333333] hover:bg-[#F8F9FA]" href="#">学术工具</a>
                        </div>
                    </div>
                    <div class="relative nav-dropdown">
                        <button class="flex items-center gap-1 hover:text-[#B83232] transition font-medium" type="button">
                            合作交流
                            <span class="iconify text-sm" data-icon="tabler:chevron-down"></span>
                        </button>
                        <div class="dropdown-menu absolute left-0 top-full mt-0 w-44 bg-white border border-gray-100 shadow-lg rounded-md py-2 opacity-0 invisible -translate-y-2 transition">
                            <a class="block px-4 py-2 text-sm text-[#333333] hover:bg-[#F8F9FA]" href="#">合作项目</a>
                            <a class="block px-4 py-2 text-sm text-[#333333] hover:bg-[#F8F9FA]" href="#">合作机构</a>
                            <a class="block px-4 py-2 text-sm text-[#333333] hover:bg-[#F8F9FA]" href="#">成果展示</a>
                            <a class="block px-4 py-2 text-sm text-[#333333] hover:bg-[#F8F9FA]" href="#">访问交流</a>
                        </div>
                    </div>
                    <div class="relative nav-dropdown">
                        <button class="flex items-center gap-1 hover:text-[#B83232] transition font-medium" type="button">
                            会议信息
                            <span class="iconify text-sm" data-icon="tabler:chevron-down"></span>
                        </button>
                        <div class="dropdown-menu absolute left-0 top-full mt-0 w-44 bg-white border border-gray-100 shadow-lg rounded-md py-2 opacity-0 invisible -translate-y-2 transition">
                            <a class="block px-4 py-2 text-sm text-[#333333] hover:bg-[#F8F9FA]" href="#">年度大会</a>
                            <a class="block px-4 py-2 text-sm text-[#333333] hover:bg-[#F8F9FA]" href="#">会议日历</a>
                            <a class="block px-4 py-2 text-sm text-[#333333] hover:bg-[#F8F9FA]" href="#">直播与回放</a>
                            <a class="block px-4 py-2 text-sm text-[#333333] hover:bg-[#F8F9FA]" href="#">会议资料</a>
                        </div>
                    </div>
                    <div class="relative nav-dropdown">
                        <button class="flex items-center gap-1 hover:text-[#B83232] transition font-medium" type="button">
                            指南与共识
                            <span class="iconify text-sm" data-icon="tabler:chevron-down"></span>
                        </button>
                        <div class="dropdown-menu absolute left-0 top-full mt-0 w-44 bg-white border border-gray-100 shadow-lg rounded-md py-2 opacity-0 invisible -translate-y-2 transition">
                            <a class="block px-4 py-2 text-sm text-[#333333] hover:bg-[#F8F9FA]" href="#">指南库</a>
                            <a class="block px-4 py-2 text-sm text-[#333333] hover:bg-[#F8F9FA]" href="#">共识申明</a>
                            <a class="block px-4 py-2 text-sm text-[#333333] hover:bg-[#F8F9FA]" href="#">指南解读</a>
                            <a class="block px-4 py-2 text-sm text-[#333333] hover:bg-[#F8F9FA]" href="#">患者教育</a>
                        </div>
                    </div>
                    <div class="relative nav-dropdown">
                        <button class="flex items-center gap-1 hover:text-[#B83232] transition font-medium" type="button">
                            会员服务
                            <span class="iconify text-sm" data-icon="tabler:chevron-down"></span>
                        </button>
                        <div class="dropdown-menu absolute left-0 top-full mt-0 w-44 bg-white border border-gray-100 shadow-lg rounded-md py-2 opacity-0 invisible -translate-y-2 transition">
                            <a class="block px-4 py-2 text-sm text-[#333333] hover:bg-[#F8F9FA]" href="#">会员权益</a>
                            <a class="block px-4 py-2 text-sm text-[#333333] hover:bg-[#F8F9FA]" href="apply-membership.html">加入我们</a>
                            <a class="block px-4 py-2 text-sm text-[#333333] hover:bg-[#F8F9FA]" href="#">会员专区</a>
                        </div>
                    </div>
                </nav>
            </div>
        </div>
    </header>

    <main class="flex-grow py-12 md:py-24 bg-light">
        <div class="container mx-auto px-4 md:px-8">
            <div class="max-w-3xl mx-auto">
                <div class="bg-white p-8 md:p-12 rounded-xl shadow-lg border border-gray-100">
                    <div class="text-center mb-8">
                        <div class="inline-flex items-center justify-center w-16 h-16 bg-primary/10 rounded-full mb-4">
                            <span class="iconify text-primary text-3xl" data-icon="ph:user-plus-bold"></span>
                        </div>
                        <h1 class="text-3xl font-bold text-secondary mb-2">申请加入会员</h1>
                        <p class="text-gray-600">请填写以下信息，我们将在3-5个工作日内审核您的申请</p>
                    </div>
                    
                    <form id="membership-form" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="fullName" class="block text-sm font-medium text-gray-700 mb-2">
                                    姓名 <span class="text-red-500">*</span>
                                </label>
                                <input type="text" id="fullName" name="fullName" required 
                                       class="w-full px-4 py-3 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                            </div>
                            
                            <div>
                                <label for="idCard" class="block text-sm font-medium text-gray-700 mb-2">
                                    身份证号 <span class="text-red-500">*</span>
                                </label>
                                <input type="text" id="idCard" name="idCard" required 
                                       maxlength="18" pattern="^[1-9]\d{5}(18|19|20)\d{2}(0[1-9]|1[0-2])(0[1-9]|[12]\d|3[01])\d{3}[0-9Xx]$"
                                       placeholder="请输入18位身份证号"
                                    class="w-full px-4 py-3 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="institution" class="block text-sm font-medium text-gray-700 mb-2">
                                    单位 <span class="text-red-500">*</span>
                                </label>
                                <input type="text" id="institution" name="institution" required 
                                       class="w-full px-4 py-3 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                            </div>
                            
                            <div>
                                <label for="position" class="block text-sm font-medium text-gray-700 mb-2">
                                    职务/职称 <span class="text-red-500">*</span>
                                </label>
                                <input type="text" id="position" name="position" required 
                                    class="w-full px-4 py-3 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                            </div>
                        </div>

                        <div>
                            <label for="phone" class="block text-sm font-medium text-gray-700 mb-2">
                                联系电话
                            </label>
                            <input type="tel" id="phone" name="phone" 
                                   class="w-full px-4 py-3 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="doctorCertificate" class="block text-sm font-medium text-gray-700 mb-2">
                                    执业医师证照片 <span class="text-red-500">*</span>
                                </label>
                                <input type="file" id="doctorCertificate" name="doctorCertificate" accept="image/*" required
                                       class="w-full px-4 py-3 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                <div id="doctorCertificatePreview" class="mt-2 hidden">
                                    <img id="doctorCertificateImg" src="" alt="预览" class="max-w-full h-32 object-contain border rounded">
                                    <button type="button" onclick="removeImage('doctorCertificate')" class="mt-2 text-red-600 text-sm hover:underline">
                                        <span class="iconify mr-1" data-icon="material-symbols:close"></span>移除图片
                                    </button>
                                </div>
                                <input type="hidden" id="doctorCertificateUrl" name="doctorCertificateUrl">
                            </div>
                            
                            <div>
                                <label for="employmentProof" class="block text-sm font-medium text-gray-700 mb-2">
                                    在职证明 <span class="text-red-500">*</span>
                                </label>
                                <input type="file" id="employmentProof" name="employmentProof" accept="image/*" required
                                       class="w-full px-4 py-3 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                <div id="employmentProofPreview" class="mt-2 hidden">
                                    <img id="employmentProofImg" src="" alt="预览" class="max-w-full h-32 object-contain border rounded">
                                    <button type="button" onclick="removeImage('employmentProof')" class="mt-2 text-red-600 text-sm hover:underline">
                                        <span class="iconify mr-1" data-icon="material-symbols:close"></span>移除图片
                                    </button>
                                </div>
                                <input type="hidden" id="employmentProofUrl" name="employmentProofUrl">
                            </div>
                        </div>

                        <div>
                            <label for="notes" class="block text-sm font-medium text-gray-700 mb-2">
                                备注
                            </label>
                            <textarea id="notes" name="notes" rows="4"
                                      placeholder="其他需要说明的信息（可选）"
                                      class="w-full px-4 py-3 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"></textarea>
                        </div>
                        
                        <div id="error-message" class="text-center font-medium"></div>

                        <div>
                            <button type="submit" 
                                    class="w-full bg-primary text-white px-6 py-3 rounded-md hover:bg-secondary transition text-lg font-medium">
                                <span class="iconify mr-2" data-icon="ph:paper-plane-right-fill"></span>提交申请
                            </button>
                        </div>
                    </form>

                    <div class="mt-8 p-4 bg-blue-50 rounded-md">
                        <p class="text-sm text-gray-700">
                            <span class="iconify text-primary mr-2" data-icon="material-symbols:info"></span>
                            <strong>温馨提示：</strong>提交申请后，您可以在个人中心查看审核进度。审核通过后，您将获得会员身份。
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <footer class="bg-secondary text-white pt-12 pb-6">
        <div class="container mx-auto px-4 md:px-8">
            <div class="border-t border-white/10 pt-6 text-center text-gray-400 text-sm">
                <p>© 2025 中欧心血管代谢联盟. 保留所有权利。</p>
            </div>
        </div>
    </footer>

    <script>
        const API_URL = 'http://localhost:8080/api';
        let currentApplicationId = null;
        let isEditMode = false;

        // 上传图片
        async function uploadImage(file, inputId) {
            if (!file) return null;
            
            const token = localStorage.getItem('token');
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch(`${API_URL}/membership/upload-image`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                const contentType = response.headers.get('content-type') || '';
                let data = null;
                let rawText = '';

                if (contentType.includes('application/json')) {
                    data = await response.json();
                } else {
                    rawText = await response.text();
                    if (rawText) {
                        try {
                            data = JSON.parse(rawText);
                        } catch (e) {
                            data = null;
                        }
                    }
                }

                if (response.ok && data && data.url) {
                    return data.url;
                }

                const statusHint = `${response.status} ${response.statusText}`.trim();
                const serverMessage = data && data.message ? data.message : '';
                const fallback = rawText && !serverMessage ? rawText : '';
                throw new Error(serverMessage || fallback || `上传失败 (${statusHint})`);
            } catch (error) {
                console.error('上传图片错误:', error);
                alert('图片上传失败: ' + error.message);
                return null;
            }
        }

        // 预览图片
        function previewImage(input, previewId, imgId, urlInputId) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById(previewId).classList.remove('hidden');
                    document.getElementById(imgId).src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        // 移除图片
        function removeImage(inputId) {
            const input = document.getElementById(inputId);
            const previewId = inputId + 'Preview';
            const urlInputId = inputId + 'Url';
            
            input.value = '';
            document.getElementById(previewId).classList.add('hidden');
            document.getElementById(urlInputId).value = '';
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const form = document.getElementById('membership-form');
            const errorMessage = document.getElementById('error-message');
            const submitButton = form.querySelector('button[type="submit"]');

            // 检查用户是否登录
            const token = localStorage.getItem('token');
            if (!token) {
                errorMessage.textContent = '请先登录后再申请会员';
                errorMessage.className = 'text-center text-red-600 font-medium';
                form.style.opacity = '0.5';
                form.style.pointerEvents = 'none';
                return;
            }

            // 图片预览事件
            document.getElementById('doctorCertificate').addEventListener('change', function(e) {
                previewImage(e.target, 'doctorCertificatePreview', 'doctorCertificateImg', 'doctorCertificateUrl');
            });
            
            document.getElementById('employmentProof').addEventListener('change', function(e) {
                previewImage(e.target, 'employmentProofPreview', 'employmentProofImg', 'employmentProofUrl');
            });

            // 检查是否有待审核的申请
            try {
                const response = await fetch(`${API_URL}/membership/my-applications`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const applications = await response.json();
                    const pendingApp = applications.find(app => app.status === 'PENDING');
                    
                    if (pendingApp) {
                        // 如果有待审核的申请，加载到表单中
                        currentApplicationId = pendingApp.id;
                        isEditMode = true;
                        
                        // 填充表单
                        form.fullName.value = pendingApp.fullName || '';
                        form.idCard.value = pendingApp.idCard || '';
                        form.phone.value = pendingApp.phone || '';
                        form.institution.value = pendingApp.institution || '';
                        form.position.value = pendingApp.position || '';
                        form.notes.value = pendingApp.notes || '';
                        
                        // 填充图片
                        if (pendingApp.doctorCertificateUrl) {
                            document.getElementById('doctorCertificateUrl').value = pendingApp.doctorCertificateUrl;
                            document.getElementById('doctorCertificateImg').src = 'http://localhost:8080' + pendingApp.doctorCertificateUrl;
                            document.getElementById('doctorCertificatePreview').classList.remove('hidden');
                        }
                        if (pendingApp.employmentProofUrl) {
                            document.getElementById('employmentProofUrl').value = pendingApp.employmentProofUrl;
                            document.getElementById('employmentProofImg').src = 'http://localhost:8080' + pendingApp.employmentProofUrl;
                            document.getElementById('employmentProofPreview').classList.remove('hidden');
                        }
                        
                        // 更新页面标题和按钮文字
                        document.querySelector('h1').textContent = '修改会员申请';
                        submitButton.innerHTML = '<span class="iconify mr-2" data-icon="material-symbols:save"></span>保存修改';
                        
                        // 显示提示信息
                        const infoDiv = document.createElement('div');
                        infoDiv.className = 'mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-md';
                        infoDiv.innerHTML = `
                            <p class="text-sm text-yellow-800">
                                <span class="iconify mr-2" data-icon="material-symbols:info"></span>
                                <strong>提示：</strong>您已有一份待审核的申请，可以在此修改申请信息。
                            </p>
                        `;
                        form.insertBefore(infoDiv, form.firstChild);
                    }
                }
            } catch (error) {
                console.error('检查申请记录错误:', error);
            }

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                errorMessage.textContent = '';
                errorMessage.className = 'text-center font-medium';

                // 验证必填字段
                if (!form.fullName.value.trim()) {
                    errorMessage.textContent = '请填写姓名';
                    errorMessage.className = 'text-center text-red-600 font-medium';
                    return;
                }
                if (!form.idCard.value.trim()) {
                    errorMessage.textContent = '请填写身份证号';
                    errorMessage.className = 'text-center text-red-600 font-medium';
                    return;
                }
                if (!form.institution.value.trim()) {
                    errorMessage.textContent = '请填写单位';
                    errorMessage.className = 'text-center text-red-600 font-medium';
                    return;
                }
                if (!form.position.value.trim()) {
                    errorMessage.textContent = '请填写职务/职称';
                    errorMessage.className = 'text-center text-red-600 font-medium';
                    return;
                }

                // 上传图片
                let doctorCertificateUrl = document.getElementById('doctorCertificateUrl').value;
                let employmentProofUrl = document.getElementById('employmentProofUrl').value;

                const doctorCertFile = document.getElementById('doctorCertificate').files[0];
                const employmentProofFile = document.getElementById('employmentProof').files[0];

                if (doctorCertFile) {
                    errorMessage.textContent = '正在上传执业医师证照片...';
                    errorMessage.className = 'text-center text-blue-600 font-medium';
                    doctorCertificateUrl = await uploadImage(doctorCertFile, 'doctorCertificate');
                    if (!doctorCertificateUrl) return;
                }

                if (employmentProofFile) {
                    errorMessage.textContent = '正在上传在职证明...';
                    errorMessage.className = 'text-center text-blue-600 font-medium';
                    employmentProofUrl = await uploadImage(employmentProofFile, 'employmentProof');
                    if (!employmentProofUrl) return;
                }

                if (!doctorCertificateUrl) {
                    errorMessage.textContent = '请上传执业医师证照片';
                    errorMessage.className = 'text-center text-red-600 font-medium';
                    return;
                }

                if (!employmentProofUrl) {
                    errorMessage.textContent = '请上传在职证明';
                    errorMessage.className = 'text-center text-red-600 font-medium';
                    return;
                }

                const formData = {
                    fullName: form.fullName.value.trim(),
                    idCard: form.idCard.value.trim(),
                    phone: form.phone.value.trim(),
                    institution: form.institution.value.trim(),
                    position: form.position.value.trim(),
                    doctorCertificateUrl: doctorCertificateUrl,
                    employmentProofUrl: employmentProofUrl,
                    notes: form.notes.value.trim()
                };

                try {
                    let url, method;
                    if (isEditMode && currentApplicationId) {
                        // 更新现有申请
                        url = `${API_URL}/membership/update/${currentApplicationId}`;
                        method = 'PUT';
                    } else {
                        // 创建新申请
                        url = `${API_URL}/membership/apply`;
                        method = 'POST';
                    }

                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(formData)
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.message || '操作失败，请重试。');
                    }

                    if (isEditMode) {
                        errorMessage.textContent = '申请已更新！我们将在3-5个工作日内审核您的申请。';
                    } else {
                        errorMessage.textContent = '申请提交成功！我们将在3-5个工作日内审核您的申请。';
                    }
                    errorMessage.className = 'text-center text-green-600 font-medium';

                    // 如果是新申请，重置表单；如果是修改，保持表单内容
                    if (!isEditMode) {
                        form.reset();
                    }

                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);

                } catch (error) {
                    console.error('提交申请错误:', error);
                    errorMessage.textContent = error.message || '操作失败，请检查网络连接后重试。';
                    errorMessage.className = 'text-center text-red-600 font-medium';
                }
            });
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const userMenuContainer = document.getElementById('user-menu-container');
            const userLoginLink = document.getElementById('user-login-link');
            const userMenuButton = document.getElementById('user-menu-button');
            const userName = document.getElementById('user-name');
            const adminLink = document.getElementById('admin-link');
            const logoutButton = document.getElementById('logout-button');
            const dropdownMenu = userMenuContainer?.querySelector('.dropdown-menu');

            const token = localStorage.getItem('token');
            const userStr = localStorage.getItem('user');

            if (token && userStr) {
                let user = null;
                try {
                    user = JSON.parse(userStr);
                } catch (error) {
                    user = null;
                }

                if (user) {
                    userLoginLink.classList.add('hidden');
                    userMenuButton.classList.remove('hidden');
                    userMenuButton.classList.add('flex', 'items-center');
                    userName.textContent = user.username || '用户';
                    dropdownMenu?.classList.remove('hidden');

                    const isAdmin = user.role && user.role.toUpperCase() === 'ADMIN';
                    if (isAdmin) {
                        adminLink.classList.remove('hidden');
                        adminLink.classList.add('flex');
                    }
                } else {
                    userLoginLink.classList.remove('hidden');
                    userMenuButton.classList.add('hidden');
                    userName.textContent = '';
                    dropdownMenu?.classList.add('hidden');
                    adminLink.classList.add('hidden');
                }
            }
            if (!token || !userStr) {
                dropdownMenu?.classList.add('hidden');
                userLoginLink.classList.remove('hidden');
                userMenuButton.classList.add('hidden');
                userName.textContent = '';
                adminLink.classList.add('hidden');
            }

            logoutButton?.addEventListener('click', () => {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                localStorage.removeItem('adminToken');
                localStorage.removeItem('isAdmin');
                window.location.href = 'index.html';
            });
        });
    </script>
</body>
</html>
